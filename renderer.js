const { startWritingTestData, stopWritingTestData } = require("./modules/test");
const { portID, DIVIDERS, CAR_PARAMS_ENTRIES } = require("./modules/constants");
const { collectTriggeredActions } = require("./modules/utils");
const SerialPort = require("virtual-serialport");
const fs = require("fs");

let settings;
let port;

const settingsPromise = new Promise((resolve, reject) => {
  fs.readFile("./settings.json", (err, data) => {
    if (err) reject(err);
    else resolve(JSON.parse(data));
  });
});

const portOpenPromise = new Promise((resolve, reject) => {
  port = new SerialPort(portID, { baudrate: 115200 });

  port.on("open", err => {
    if (err) reject(err);
    else resolve();
  });
});

function tryConnectingToPort() {
  port = new SerialPort(portID, { baudrate: 115200 });

  port.on("open", err => {
    if (err) renderErrorScreen();
    else if (settings.selectedGroundType) actions.startListeningToData();
    else renderGroundTypeForm();
  });
}

function handleInitializationError(err) {
  console.error(err.message);
  renderErrorScreen();
}

function renderErrorScreen() {
  document.getElementById("content").innerHTML = `
  <main class="error-page">
    <h2 class="screen-title error">Пожалуйста, подключите машинку к стенду</h2>
    <button class="btn" data-action="reconnect">Сделано!</button>
  </main>
  `;
}

Promise.all([settingsPromise, portOpenPromise])
  .then(([resolvedSettings]) => {
    settings = resolvedSettings;
    if (settings.selectedGroundType) actions.startListeningToData();
    else renderGroundTypeForm();
  })
  .catch(handleInitializationError);

document.addEventListener("click", handleClick);

function handleClick(event) {
  const triggerdActions = collectTriggeredActions(event);
  for (const action of triggerdActions) {
    actions[action.type](action.target);
  }
}

const actions = {
  reconnect() {
    showSpinner();
    tryConnectingToPort();
  },
  selectGroundType(target) {
    if (checkIfPrevSelectedSame(target)) deselectCurrentGroundType(target);
    else selectOtherGroundType(target);
  },
  startListeningToData() {
    startWritingTestData(port);
    renderCarDataTable();
    port.on("data", handleCarData);
  }
};

function selectOtherGroundType(selected) {
  const previouslySelected = document.querySelector(".clickable-area.selected");
  if (previouslySelected) previouslySelected.classList.remove("selected");
  selected.classList.add("selected");
  document.querySelector('[data-action="startListeningToData"]').disabled = false;
}

function checkIfPrevSelectedSame(selected) {
  return document.querySelector(".clickable-area.selected") === selected;
}

function deselectCurrentGroundType(selected) {
  selected.classList.remove("selected");
  document.querySelector('[data-action="startListeningToData"]').disabled = true;
}

function renderGroundTypeForm() {
  document.getElementById("content").innerHTML = `
  <header class="screen-title">Выберете тип покрытия</header>
  <main class="ground-types">
    <div
      class="clickable-area"
      data-groundType="gravel"
      data-action="selectGroundType"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 300">
        <path
          d="M282 214.2c-2-2.4-4.7-4.2-7.7-5.1 1.5-.6 2.9-1.4 4.1-2.6 2.1-2.1 3-5.1 2.3-7.9-.7-4.2-3.3-7.8-7-10-3.6-2.1-7.9-2.5-11.7-1-.9.3-1.7.7-2.5 1.3-1.3 1-2.3 2.3-3 3.8l-.3-.6c-3.9-5.4-8.7-10-14.3-13.6l-.3-.1c-1.1-.5-2.2-.9-3.3-1.2 6-1.6 9.4-4 10.9-7.4 2-4.8-.7-10-3.6-14.4-1.4-2.7-3.9-4.6-6.8-5.4-3.8-.6-7 1.8-11 4.9-1.1.9-2.4 1.8-3.8 2.8l-.5.5c.6-2.4.8-4.9.5-7.4-.6-7.6-2.6-12.4-6.4-15.3-1.7-1.2-3.6-2.1-5.7-2.5 2.2-.2 4.5-.7 6.6-1.5 5.6-2.1 9.8-6.9 10.9-12.8 1-7.1-1.9-14.2-7.5-18.6-5.1-4.7-12.5-5.6-18.6-2.3-3.6 1.6-6.4 4.5-7.9 8.1-.5 1.3-.8 2.7-.9 4.1-.6-.7-1.4-1.3-2.1-1.8-3.4-1.7-7-3.3-10.6-4.6h.4c6.4-1.9 20.7-9 21.8-17.5.4-3.9-1.8-7.6-5.4-9.2-7.8-4.7-18.8-9.6-27-6.8-.4 0-.8.4-1.2.5 1.2-4.5 1.2-9.2 0-13.7-1.1-5.4-3.4-9-6.7-10.5-4.7-2.2-10 0-14.1 2.2-1.1.6-10.6 5.8-13.6 13.1-1 2-1.1 4.4-.1 6.4 1.5 2.4 4 4 6.8 4.5-5.7.6-13.4 2.3-18 7.1-3 3.2-4.4 7.6-3.7 12 1.1 10 5.6 14.6 9.4 16.7-3.5 1.8-6.7 4.2-9.4 7.1-.7.8-1.3 1.5-2 2.2v-.3c.2-5.4-3.8-11.1-12.2-17.3-4.4-3.7-10.6-4.2-15.5-1.1-7 4.3-11.3 14.8-10.3 20.7 1 4.4 4 8 8.1 9.8-1.9.1-3.7.7-5.3 1.6-2.2 1.4-3.6 3.8-3.8 6.4v.6c-.6 6-1.1 12.2 2.8 16.6.9 1 1.9 1.8 3 2.4h-.3c-6 .2-11.2 4.5-15 12.8-1.7 3.8-2.7 11 10.6 17.6 1.3.7 2.7 1.3 4.1 1.8-2.4.7-4.4 2.2-5.8 4.2v-1.6c-.7-4.2-3.3-7.9-7-10-3.6-2.1-7.8-2.4-11.7-1-.9.3-1.7.7-2.5 1.3-2.8 2.5-4.6 5.8-5.1 9.5l-.2.9c-.3 1.3-.5 2.6-.4 3.9-4.4-.9-8.9-.3-12.8 1.7-3.7 1-6.7 3.8-8 7.4-1.2 4.4 1.5 8.6 4 11.7.5.7 6.5 7.9 13 9.3.7.2 1.4.2 2.1.2 1.3 0 2.6-.4 3.6-1.1 2.6-2 3-5.6 3.4-11 0-1.6.3-3.5.5-5.5s.2-4-.2-6l.6.2c2 .4 4 .5 6 .5 4.5.3 8.9-1.1 12.4-4 .2-.2.4-.5.6-.7-.2 3.8.5 7.6 2.1 11.1l.4 1.4c-3.2-2.3-7.3-3.1-11.2-2.2-4.6 1.3-8.2 6.2-10.1 10.4-3 7.1-2.1 13.5 2.5 16.7 1.8 1.2 4 1.8 6.2 1.7 3.3-.2 6.5-.8 9.7-1.8l.6-.2c7-2 11-5.1 12-9.2.2-.7.2-1.4.2-2.2 1.8.6 3.7.9 5.6 1h.9c2.2 0 4.4-.4 6.4-1.3-.1 1.1-.1 2.3 0 3.4 0 1.3.2 2.6.4 3.9.6 2.9 2.5 5.3 5.2 6.5 2.7 1.3 5.6 2 8.6 2h2c2.2-.2 4.3-1.1 6-2.6.3.8.6 1.6 1 2.3.1.2.2.3.3.5 7 9 14.2 13.8 21.4 14.1h.8c4.2 0 8.2-1.6 11.3-4.5l.3-.4c1.1-1.6 9-13.7 8.4-23.5.8.3 1.6.5 2.5.5 2.4.1 4.8.4 7.1.9 2.5.5 5 .8 7.5.9 3 .2 6-.9 8.2-3l1.1-1.2c-.1.7-.1 1.4 0 2.1 1.3 5.5 5.3 10 10.6 12 3.5 1.5 7.2 2.3 11 2.3 5 .1 9.8-1.2 14.1-3.8 6-3.8 9.2-8.2 9.4-13.1-.2-5-2.4-9.8-6.2-13.1 2.4 0 4.7-.4 7.1-1 4.9-.9 9.4-3.2 13-6.7.1 1.3.5 2.6 1.2 3.7.6.9 1.4 1.6 2.3 2.2-2.9.9-5.3 3.1-6.4 6-1 4.2-.2 8.7 2.4 12.2 3.5 4.7 9.1 7.4 15 7.3h2.4c5.5-.4 10.4-3.9 12.4-9 1.4-3.7 1-8-1.4-11.3zm-229.8-6c-.2 2.1-.4 4-.5 5.8-.1 2.2-.3 4.4-.8 6.6-.3.1-.7.1-1 0-3.8-1.5-7.1-4-9.6-7.2-.9-1.1-3.4-4.4-3-6.5.3-1.2 1.9-2.4 4.4-3.4 6.6-2.6 8.8-1.7 9.4-1.3s1.4 2.9 1.1 6zm20.4-13c-2 2-7.5 2.8-13.1 1.8-.4 0-.8-.2-1-.5-.3-.9-.3-1.9 0-2.8l.2-1c.3-2.2 1.2-4.3 2.8-6 .3-.2.6-.4 1-.5.9-.3 1.8-.5 2.8-.5 1.4 0 2.7.4 3.9 1.1 2.2 1.3 3.7 3.5 4.1 6 .1.9-.1 1.8-.7 2.4zm149.6-9c-1.8 4.7-2.3 9.7-1.4 14.6-3.4-1.4-7.2-1.4-10.7 0 3.9-3.3 6.9-9.8 8-18.3 1-4.7-.4-9.5-3.8-12.8-1.5-1.3-3.2-2.2-5.1-2.8 3 0 6-.6 8.7-1.9-.5 1.1-.9 2.3-1.1 3.6v.5c.2 2.7 1.5 5.1 3.6 6.8 2.2 1.6 4.9 2.5 7.7 2.6-2.8 1.7-4.9 4.5-5.9 7.7zM164.6 218c-3.2-3-8.4-4.1-15.4-3.5-2.9.2-5.9.7-8.7 1.4 1.2-1.1 2.2-2.4 3-3.8 1.1-2 1.5-4.2 1.2-6.4 4.6 2.9 9.9 4.4 15.3 4.4 1.5 0 3-.1 4.5-.4.9-.2 1.7-.3 2.5-.5-1.2 2.7-2 5.7-2.4 8.8zm-39.9 4.7c-3-2.7-6.9-4.3-10.9-4.6-1.2-.1-2.4-.1-3.6 0 1.6-2.8 2.5-6 2.6-9.2.4 1.3 1 2.6 1.6 3.8 3 6 7.5 9.2 12.8 9.2h1.7c-1 .9-1.8 1.9-2.5 3-.5-.8-1-1.5-1.7-2.2zM105 178.4c1.1 3 2.4 5.9 4 8.6l.3.4c2.4 2.6 5.3 4.6 8.5 6-1.8.7-3.4 2-4.6 3.5-.7 1-1.2 2.1-1.4 3.3-1.6-7.1-5.3-11-15.2-12 1.1-.7 2.1-1.5 3-2.5 2.1-2.2 3.9-4.7 5.4-7.3zm57.6-99.3c-.2.5-.3.9-.5 1.4-.7-1.4-1.5-2.7-2.5-3.8h1.2c1 0 2-.1 3-.4-.4.9-.8 1.9-1.2 2.8zm-18 30.6c1.6-.4 3.2-.9 4.8-1.5-.6 1.8-1 3.7-1 5.6-1.1-1.5-2.4-2.9-3.8-4.1zm29.4 88.1c-1.6 3-5.1 4.9-10.4 5.8-8.5 1.5-19.8-3-22.2-11.4-1.9-6.7.9-9.4 1.5-9.8 4.4-2.1 16.5-6.7 24-4 2.6.9 4.6 2.8 5.6 5.3 2.6 6.1 3.1 10.8 1.5 14.1zm-39.3-8.1c.1 1.4.4 2.8.8 4.2 0 .4.2.7.4 1.1-2-.9-4-1.7-6.1-2.2 1.5-.8 3.2-1.9 4.9-3.1zm-9.5 8.3h1.2c4 .8 10.7 2.8 12.2 7.3.4 1.2.3 2.5-.4 3.7-2.1 3-5.2 5.1-8.7 6-4.1 1.2-7.4-.6-9.8-5.5-2.1-4.3-2.7-7.7-1.5-9.4 2-1.6 4.5-2.4 7-2.1zm36.4-30.6c-4.4-.7-8.3-3.3-10.7-7.1-1.2-1.9-1.4-4.3-.6-6.4 3.7-3.7 8.5-6 13.6-6.4 6.2 0 12.1 2.5 16.4 7 3.7 3.4 5.5 6.4 4.8 7.9-1.8 4-16.3 5.6-23.5 5zm-6.6-24c.8-1.7 1.2-3.5 1.4-5.4 1.4 1.5 3.1 2.8 4.9 3.7-2.2.3-4.3.9-6.4 1.8v-.1zm-9.3 19.8c2.4 4 6 7.1 10.3 8.8-3.8.6-7.6 1.6-11.2 3 .2-1.4.3-2.8.2-4.3.3-5.5-1.9-10.9-6-14.7-.3-.3-.7-.5-1.1-.7 2.1-.3 4.1-.9 6-1.6-.6 3.3 0 6.7 1.8 9.5zm-10.4-2.4c2.4 1.9 3.6 5.1 3.8 10.2.3 8.6-4.5 12-12.5 16.7-5.1 3-11.3-3-12.4-4.1-2.2-3.7-6.8-13.7-4.3-19.5 1.5-2.8 4.3-4.6 7.4-4.8 8.7-1.6 14.7-1.1 18 1.5zm42.6 20.5c-1.5-3.6-4.4-6.5-8-8 7.7-.5 18-2.3 20.7-8.5.3-.7.5-1.4.6-2.1 1.8 1.9 4.1 3.2 6.7 3.8l-3 .6c-4.1.7-7.6 3.3-9.5 6.9-3.7 7.3 0 17.1.6 18.8.4 1.7 1.2 3.3 2.2 4.7-2.7-.3-5.5 0-8 1 1.4-4.6.7-10.4-2.3-17.2zm13.7 10v-.5c-1-2.4-3-9.6-.8-14 1.1-2.1 3.2-3.5 5.5-3.9 2.4-.6 4.8-.9 7.3-1 2.4-.2 4.9.5 6.8 2 1.8 2.1 2.5 4.9 1.9 7.6-1.3 9.6-4.9 15-7.9 15.6-1.2.2-11 1.6-12.8-5.8zm35.8-29c1.4-1 2.7-2 3.9-3 2.6-2 5.1-4 6.4-3.8.4 0 1.3.5 2.8 2.8s4 6.6 3 8.8-4 3.4-9.2 4.5c-4.7.9-8.3.7-10.1-.7-.7-.5-1.2-1.3-1.4-2.1.7-2.6 2.3-4.9 4.6-6.5zM218 151c.5 2.6 0 5.3-1.5 7.5-1.8 2-5.4 2.1-8.6 2.3h-2.2c-6 .3-9.9.2-12.3-6-.8-4.1-.3-8.3 1.6-12 1.4-2.1 3.7-3.4 6.2-3.8 6.3-1.1 10.3-.8 12.7 1s3.5 5.2 4.1 11zm-17-43.1c1-2.2 2.8-4 5-4.9 1.6-.8 3.3-1.2 5.1-1.3 2.5 0 5 1 6.9 2.7 4.1 3 6.2 7.9 5.6 13-.7 3.8-3.4 6.9-7 8.3-3.1 1.4-6.6 1.5-9.7.4-2-1-3.5-2.7-4.2-4.9-2.5-6.2-3-10.2-1.7-13.3zm-3.9 15.7c1.5 4.5 5.2 7.8 9.8 8.8-2.2.1-4.4.3-6.6.7-4.1.6-7.8 2.9-10.1 6.4-2.4 4-3.4 8.7-3 13.3-.9-1-1.8-1.9-2.7-2.8-3.3-3.1-7.2-5.6-11.5-7.1 3.3-.7 6.4-2 9.2-3.8 7.8-5.3 12.9-10.4 14.8-15.5h.1zm-5.1-5.3c0 4.4-4.7 10-13.3 15.7-.3.2-8 5.2-14.3 2.5-4.8-2.1-8-8-9.6-17.7-1-5.8-.2-9.7 2.4-11.6 2-1.2 4.2-1.8 6.5-1.7 7.8 0 18.9 4.1 25.6 7.6 1.6 1.2 2.6 3.2 2.7 5.2zm-30.8-18.5c.9-1.4 1.7-2.8 2.2-4.4.6 1.1 1.3 2.1 2.2 3 .5.5 1 1 1.5 1.4-2-.2-3.9-.2-5.9 0zm12.4-24.2c1.1-.4 2.3-.6 3.5-.6 6.6.6 12.8 2.9 18.2 6.7 2.7 1.6 2.6 3 2.5 3.3-.5 4-10.3 10.3-17.6 12.5-3.8.9-7.8-.4-10.4-3.3-3.1-3.6-3.7-8.7-1.7-13 1-2.6 3-4.7 5.5-5.6zm-31.8-11.8c1.8-4.5 8.4-8.8 10.8-10.1 4.2-2.2 7-3 8.7-2.1s3 3.9 3.4 6.3c1.7 8.3.3 11-.7 12-1.6 1.5-5.2.9-7.9 0s-4.7-1.3-6.6-1.8c-2.8-.5-5.5-1.4-8-2.8-.1-.5 0-1 .3-1.5zm-12.6 20c4.3-4.6 14.2-5.6 19.1-5.6h1.7c3.6-.3 6.5 3.4 7.6 7 1.9 5.7-.5 12-5.8 15-7.1 4.1-13.7 5.2-18 3s-6.2-8-6.7-12.4c-.5-2.5.3-5.1 2.1-7zm-3.8 35.7c5.2-5.5 9.6-7.6 13.1-6.5 7.3 2.4 11 18.9 12 25-.4 3.2-2.1 6.1-4.6 8-4.8 3.8-13 4.7-23.7 2.7-3.4-1.5-6-4.5-7.1-8.1-1.1-5.6 2.4-12.8 10.3-21.1zm-38.4-1c.2-5.8 2.9-11.1 7.6-14.6 1.1-.7 2.4-1.1 3.7-1.1 1.9.1 3.7.8 5.1 2 8.3 6 9.9 10 9.8 12.3s-1.9 4.2-5.2 6.3c-4.7 2.8-10.4 3.2-15.4 1-2.7-1-4.8-3.2-5.6-5.9zm24.7 9.6c-2 3.7-3 7.8-2.7 12-1.2-3.6-3.7-6.7-7-8.6 3.2-.3 6.3-1.4 9-3l.7-.4zM86 138.5v-.6c0-.8.3-1.5 1-1.9 1.1-.6 2.4-.8 3.7-.8 2.9.1 5.7.6 8.4 1.5h.2c2.6 1.7 4.2 4.4 4.5 7.5 0 .9.2 1.8.4 2.7.3 1.8.7 3.8 0 4.8-.5.5-2.1 1.7-7.6 1.5-3.3.2-6.7-.8-9.2-3-2.3-2.2-1.9-6.8-1.4-11.7zm10.3 21h1.3c5.3 0 9-1.2 11-3.7 2-2.9 2.6-6.5 1.5-9.8-.1-.5-.2-1.1-.2-1.6v-.4c1.5 3.9 4.3 7.1 7.9 9.2l-1.5.2c-6.7.5-12.2 5.7-12.9 12.4-2.8-2.7-5.9-4.9-9.5-6.5l2.4.2zm-20.4 12.7c2.8-6 6-9.2 9.8-9.3 4.3 0 15 6.7 15.2 10.2-.1.5-.3 1-.5 1.4-1.4 2.6-3.1 5.1-5.1 7.3-1.4 1.9-3.7 2.7-6 2.3-2-.5-3.8-1.2-5.6-2.2-4.6-2.3-9.7-5.8-7.8-9.7zm7.9 53.3c-.4 1.8-3.3 3.6-7.9 4.9l-.7.2c-2.8.8-8.5 2.5-10.7 1-2.2-1.5-1.8-6.2-.4-9.4 1.1-3 3.3-5.6 6.1-7 3.3-.9 7.1 1.1 12 6.3 1.2 1 1.7 2.5 1.6 4zm12-5.7c-6.7-.3-8.4-3-10.5-11.4 0-.2-.1-.4-.2-.5-.9-1.9-3-8-1-11.2 1.6-1.9 4.1-2.9 6.6-2.5h1.5c13.4 0 13.8 3.8 14.6 12 .6 3.9-.6 7.8-3.1 10.8-2.1 2-5 3.1-7.9 2.8zm26 12.7c-.8 1.1-2.1 1.7-3.5 1.8-2.5.3-5.1-.1-7.4-1.3-1.1-.4-1.9-1.3-2.1-2.5-.2-1-.3-2-.3-3 0-1.6 0-2.5.5-3s.8-.6 2.2-.6h1.6c2.8.2 5.4 1.2 7.5 3 1.8 1.4 2.3 3.7 1.5 5.6zm33.4 13.7c-2.1 1.7-4.7 2.6-7.4 2.5-5.2-.3-10.9-4.3-16.6-11.5-1.3-2.9-1.3-6.1 0-9 2.3-4.2 8.7-6.9 18.5-7.7 4.4-.4 10 0 12 3 2.8 5.1-2.4 16.5-6.5 22.7zm34.3-24.9c-2 2-6 1.2-10.4.4-2.5-.5-5.1-.8-7.7-.9h-.6c-.8-1.2.5-6.6 2.6-11.4 2.1-1.8 11.4-9.2 17.7-4.2 2.1 1.3 3.4 3.5 3.7 6 .2 4.2-3.6 8.5-5.3 10.1zm8-18.3c1.3.3 2.7.4 4 .4 1.3 0 2.5-.1 3.8-.3.3-.1.6-.2 1-.3-2.2 1.7-4.2 3.7-5.7 6-.6-2.2-1.7-4.2-3.1-5.8zm30 29c-5.9 3.5-13.1 4-19.3 1.2-3.5-1.2-6.1-4.1-7.1-7.6-.8-4.4 3.3-14.6 9.5-18.4 3.6-2.3 8.3-1.8 11.4 1.1 8.1 6 12.4 11.4 12.2 15.5-.2 2.7-2.6 5.5-6.7 8.2zm22.9-34.2c-1 1.8-3.6 4.4-10.9 6.2-3.8 1-8.8 1.5-11.3-1.2s-2.5-8.2-.3-14.7c.5-2.2 1.9-4.1 3.9-5.2.8-.3 1.6-.5 2.5-.5 1.5 0 3 .4 4.3 1 4.6 3.1 8.7 7 12 11.5.3 1.1.2 2-.2 2.9zm9.8 3l.2-1c.3-2.2 1.2-4.3 2.8-6 .3-.2.6-.4 1-.5.9-.3 1.8-.5 2.8-.5 1.4 0 2.7.4 3.9 1.1 2.2 1.3 3.7 3.5 4 6 .3.9 0 1.9-.7 2.6-2 2-7.5 2.8-13 1.8-.4 0-.8-.2-1-.5-.5-.9-.5-2 0-3zm17.5 22.6c-1.5 3-4.4 4.9-7.7 5-4.5.6-8.9-1.1-11.8-4.6-.8-1.1-2.6-4.9-1.6-7.2 1.1-2.3 4.3-2.8 7-3 4.6-.5 11 1 13.5 4.2 1.2 1.7 1.4 3.8.6 5.6zm-241.3-2.6c-4.4-2.2-9.6-2.2-14 0-3.6 2.4-6 6.2-6.6 10.5-.2 1.5.8 3 2.3 3.3l12.9 2.8h1.4c3.4-.9 11.2-3.6 11.5-8.8.4-4.6-5.5-7-7.5-7.8zm-4.8 10.6l-9-1.9c.6-1.4 1.7-2.7 3-3.5 2.8-1.2 6-1.1 8.7.4 1.3.5 2.6 1.1 3.7 2-1.9 1.4-4 2.4-6.4 3zm221.7 1.9c-4.4-2.2-9.6-2.2-14 0-3.6 2.4-6 6.3-6.6 10.5-.2 1.5.8 3 2.3 3.3l12.9 2.8h1.4c3.4-.9 11.2-3.6 11.5-8.8.4-4.7-5.5-7.1-7.5-7.8zm-4.8 10.5l-9-2c.6-1.5 1.7-2.7 3-3.5 2.8-1.2 6-1 8.7.4 1.3.5 2.6 1.1 3.7 2-1.9 1.5-4.1 2.6-6.4 3.1zm-62-14c-4-.4-8.1.4-11.6 2.5-3 1.3-5.2 3.9-6 7.1-.2 2.7.7 5.3 2.6 7.3.8 1.1 1.6 2.1 2.6 3a9.1 9.1 0 006.3 2.5h1.7c3.6-.6 7-2.2 9.8-4.6 4.3-3.3 5.1-9.5 1.8-13.8-1.7-2.2-4.3-3.6-7.1-3.8v-.2zm1.3 13.2c-1.9 1.6-4.2 2.6-6.6 3-1.1.3-2.2 0-3-.8-.7-.7-1.4-1.5-2-2.4-1-1.3-1.4-2.1-1.3-2.7.1-.6.5-1.3 3-2.6 2.3-1.5 5.1-2.1 7.9-1.9 1.9.3 4 1.9 4.1 3.8-.1 1.4-.8 2.8-2.1 3.6z"
        />
      </svg>
      Грунт
    </div>
    <div
      class="clickable-area"
      data-groundType="asphalt"
      data-action="selectGroundType"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 716.79 445.42">
        <path
          d="M359.54 445.4H48.09a82.47 82.47 0 01-22.71-2.94 41.06 41.06 0 01-16.2-8.59c-7.8-6.84-10.84-15-8.31-25.47q18.57-77 36.71-154.07Q65.53 136.2 93.28 18c1.21-5.14 4.37-8.07 8.79-10.09C113.48 2.73 125.67 1 138 .2c4.81-.33 9.66-.15 14.5-.15h365.94c14.6 0 28.9 1.71 42.63 7.05 6.42 2.5 10.6 6.51 12.69 13.53 26.52 89 59.54 175.71 92.75 262.36q24.32 63.45 48.24 127.08c4.5 11.89 1.6 20.52-9.18 27.46-9.91 6.37-21.13 7.86-32.58 7.86q-132.22.08-264.46 0zm-1.83-26.4c24.67 0 46.32.06 68 0 7.92 0 10.57-2.95 9.46-10.35-5.87-38.82-11.87-77.65-17.58-116.47-.8-5.45-3.7-7.46-8.58-7.76-5.15-.31-10.3-.63-15.46-.71-25.64-.39-51.29.21-76.92-.94-8-.36-16-.23-24-.1-6.28.11-8.61 2.31-8.76 7.74q-1.58 58.65-3.11 117.32c-.21 8.38 1.47 10.2 10 10.67 23.33 1.29 46.66.15 66.95.6zm23.86-202c5.5 0 11 .11 16.49 0s6.92-1.84 6-7.17c-4.12-23.9-8.44-47.83-12.36-71.83-.78-4.75-3.15-6.68-7.43-7.1-2-.2-4-.23-6-.24-19.49-.14-39-.22-58.48-.41-8.16-.08-16.31-.46-24.47-.58-4.31-.06-6.58 1.68-6.69 6.56-.52 23.48-1.37 46.94-2 70.41-.21 7.55.61 8.32 8 8.71 28.97 1.54 57.99.01 86.94 1.73zM336.65 83v.36h37.47c7.24 0 7.92-1 6.77-8.31q-4.35-27.6-8.51-55.24c-.9-5.95-2-7.15-8-7.16q-31.47-.09-63 0c-6 0-7.18 1.19-7.53 7.32q-1.51 27.41-3 54.82c-.38 7 .65 8.2 7.75 8.24 12.74.05 25.4-.03 38.05-.03z"
        />
      </svg>
      Асфальт
    </div>
    <div
      class="clickable-area"
      data-groundType="linoleum"
      data-action="selectGroundType"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 230.95">
        <path
          d="M256 2.33v199c-2.71 2.8-6.27 2.87-9.77 2.88q-29 .07-57.94.06l-64.44.06c-2.51 0-5.32-.29-6.3 2.77-3.22 10.1-11.59 14.46-20.49 17.45-25.23 8.49-50.7 8.48-76 .29C12.11 222 4.35 217.21 0 208.33v-186c3.38-6.71 8.87-11.1 15.57-14.14A93.72 93.72 0 0154.37.12C118.75 0 183.13.05 247.51 0A14.24 14.24 0 01256 2.33zm-144.87 9.42l-.76 1.51c7.37 5.66 8.09 13.45 7.85 21.69-.23 7.82.07 15.65-.09 23.46-.08 4 1.22 5.86 5.48 5.62 4.47-.25 9 0 13.47 0h95.86c6.43 0 6.66-.32 6.67-6.87 0-13.48-.05-27 .07-40.44 0-3.63-1.26-5-5-5-36.1.08-72.19 0-108.29 0zM179 128.05c18.31 0 36.63-.1 55 .06 4.32 0 5.87-1.44 5.81-5.8q-.3-20.48 0-41c.07-4.5-1.64-5.71-5.91-5.59-10.64.29-21.29.23-31.94.21-25.79 0-51.59-.06-77.38-.26-4.82 0-6.43 1.92-6.37 6.57q.27 19.73 0 39.46c-.06 4.66 1.5 6.46 6.38 6.4 18.06-.19 36.21-.05 54.41-.05zm-.17 64V192c18.48 0 37-.09 55.43.07 4.18 0 5.54-1.52 5.49-5.58-.17-13.48-.22-27 0-40.45.06-4.52-1.59-6.34-6.09-6.3-13.64.13-27.29 0-40.93.07-22.78 0-45.56.22-68.34 0-4.59 0-6.28 1.14-6.21 5.8.21 13.31.27 26.63 0 39.95-.09 5.08 1.83 6.62 6.73 6.56 17.92-.19 35.89-.07 53.87-.07zM11.31 66.53v12c0 10.7 2.58 14.33 12.75 18a70.2 70.2 0 007.67 2.25c14.29 3.43 28.8 2.72 43.25 1.82a56.81 56.81 0 0022.12-5.7c4.52-2.28 8.73-5.11 8.73-11.1 0-11.16 0-22.32.08-33.49 0-3.28-.69-4.45-4.41-3.1-29 10.48-57.94 10.58-86.77-.54-3-1.15-3.47-.29-3.44 2.37.07 5.83.02 11.66.02 17.49zm0 58.82c0 4.66.35 9.35-.08 14-.63 6.87 2.7 11 8.33 14a46.15 46.15 0 009.31 3.54c13.85 3.85 28 3.7 42.15 2.87 9.45-.55 18.91-2 27.4-6.81 4.06-2.27 7.42-5.18 7.43-10.4v-34.46c0-3.25-1.06-3.47-3.93-2.38q-43.32 16.45-86.69-.07c-3.48-1.33-4-.35-4 2.78.17 5.58.1 11.26.09 16.93zm0 58.83c0 4.32.41 8.7-.09 13-.88 7.57 2.68 12 9.22 14.65 2.46 1 4.94 2 7.48 2.78 15.56 4.72 31.47 5.19 47.44 3.13 8.73-1.13 17.35-3.17 25.07-7.83 3-1.81 5.36-4 5.37-7.83v-35.44c0-3-1.16-3.16-3.76-2.2-28.89 10.62-57.85 10.7-86.71-.11-3.59-1.35-4-.07-4 2.9.05 5.63.01 11.29.01 16.95zM58.46 42.69A108.93 108.93 0 0086.19 40c6.34-1.52 12.55-3.49 17.16-8.53 3.08-3.36 3-6-.57-8.9-4.07-3.31-8.94-5-13.89-6.59-9.14-2.88-18.59-3.83-28.06-4-13.36-.2-26.62 1.06-39.09 6.43-4.19 1.84-9.81 3.59-9.74 8.88s5.34 7.59 9.8 9.56C33.52 42 46 42.48 58.46 42.69zm.29-21c-3.5-.06-5.66 2.1-5.72 5.54A5.24 5.24 0 0058.58 33c3.42 0 5.42-2 5.75-5.57-.22-3.52-2.11-5.65-5.58-5.71z"
        />
      </svg>
      Линолиум
    </div>
    <div
      class="clickable-area"
      data-groundType="tiles"
      data-action="selectGroundType"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 366.79">
        <path
          d="M512 187.31a15.06 15.06 0 01-4.87 4.92q-30.48 21.83-60.95 43.67c-5.33 3.82-9.2 3.84-14.66-.06q-29.91-21.33-59.71-42.8c-8.89-6.42-8.87-13.1 0-19.48q29.81-21.48 59.76-42.76c5.69-4.05 9.25-3.93 15 .2q29.9 21.36 59.77 42.73a22.53 22.53 0 015.65 5.58zm-512 0a23.5 23.5 0 006.06 5.87q29.3 20.88 58.55 41.82c7 5 10 5 17.07-.07q29.67-21.24 59.32-42.5c7.66-5.5 7.74-12.68 0-18.28q-30.4-21.91-60.94-43.65c-4.93-3.52-9-3.53-13.83-.08q-30.72 21.9-61.4 43.89a22 22 0 00-4.83 5zM354.33 300c20.56-14.74 41.17-29.42 61.68-44.24 6.88-5 6.89-11.91 0-16.87q-30.76-22.23-61.68-44.23c-5.34-3.82-9.21-3.7-14.64.18q-30.06 21.49-60.07 43.06c-8.29 6-8.32 12.83 0 18.82q30.18 21.75 60.46 43.36c2.06 1.48 4.2 2.74 6.91 2.53 2.82.21 5.13-1.03 7.34-2.61zM157.79 194.53q-30.85 22.13-61.71 44.27c-6.64 4.79-6.68 12.18 0 17q30.77 22.26 61.73 44.24c5.25 3.74 9 3.66 14.21 0q29.91-21.33 59.73-42.75 13.72-9.89 0-19.8c-19.85-14.39-39.75-28.6-59.68-42.87-2.21-1.58-4.54-2.8-7.38-2.6-2.64-.13-4.83 1.03-6.9 2.51zm.42-128.28C137.36 81.16 116.47 96 95.7 111c-6.55 4.74-6.48 11.82.12 16.6q30.93 22.4 62.09 44.51c5.16 3.67 9 3.48 14.23-.26q30.47-21.75 60.86-43.62c7.39-5.32 7.34-12.56-.11-17.93Q202.52 88.4 172 66.64c-2.21-1.59-4.52-2.82-7.49-2.63a9.72 9.72 0 00-6.3 2.24zm165.45 107.67q-29.66-21.18-59.29-42.46c-6.73-4.82-10-4.83-16.7 0Q217.82 152.79 188 174.2c-7.4 5.31-7.57 12.72-.24 18q30.58 22.07 61.28 44c4.45 3.19 9 3.43 13.45.26q31.51-22.47 63-45.06a8.38 8.38 0 003.89-7.68c.31-4.54-2.27-7.34-5.72-9.8zM340 66.56Q309.76 88.25 279.51 110c-8 5.75-8 12.91-.1 18.62q30 21.61 60.12 43.06c5.77 4.12 9.38 4.23 15.05.19q30.72-21.9 61.31-44c6.64-4.79 6.75-12.22.1-17-20.64-14.93-41.41-29.7-62.14-44.52a10.4 10.4 0 00-7-2.28c-2.63-.2-4.78 1-6.85 2.49zm-92.47-63L188.25 46c-7.82 5.61-7.81 13 0 18.61q29.63 21.27 59.28 42.49c6.81 4.88 10 4.9 16.69.12Q294.14 85.89 324 64.49c7.37-5.29 7.63-12.76.35-18-20.24-14.64-40.58-29.13-60.88-43.68C261.26 1.2 259-.14 256.07 0c-3.4-.25-5.95 1.67-8.54 3.52zm.16 255.83q-30 21.54-60.08 43.09c-7 5-7 12.69.07 17.77q30 21.62 60.1 43.05c6.69 4.77 10 4.69 16.73-.15q29.85-21.37 59.68-42.79c7-5 7.27-12.75.33-17.76-20.39-14.72-40.87-29.3-61.32-43.93-2.21-1.59-4.53-2.82-7.37-2.6-3.25-.26-5.69 1.52-8.14 3.28z"
        />
      </svg>
      Плитка
    </div>
    <label>
      <input type="checkbox" name="remember" />
      Запомнить
    </label>
    <button class="btn" disabled data-action="startListeningToData">Далее</button>
  </main>
  `;
}

function showSpinner() {
  document.getElementById("content").innerHTML = `
  <main class="loader">
  <div class="spinner-box">
    <div class="blue-orbit leo"></div>

    <div class="green-orbit leo"></div>

    <div class="red-orbit leo"></div>

    <div class="white-orbit w1 leo"></div>
    <div class="white-orbit w2 leo"></div>
    <div class="white-orbit w3 leo"></div>
  </div>
  <p class="spinner-caption">Соединение</p>
</main>
  `;
}

function renderCarDataTable() {
  document.getElementById("content").innerHTML = `
  <header class="page-title">Параметры работы машинки</header>
  <main>
    <table class="parameters">
      ${Object.keys(CAR_PARAMS_ENTRIES)
        .map(
          id => `
        <tr>
          <td class="parameter-name">${CAR_PARAMS_ENTRIES[id].label}</td>
          <td class="parameter-value" id=${id}>Нет данных</td>
        </tr>
      `
        )
        .join("\n")}
    </table>
  </main>
  `;
}

function handleCarData(buffer) {
  const dataArray = new Uint8Array(buffer);

  let i;

  for (i = 0; i < DIVIDERS.length; i++) {
    if (dataArray[i] !== DIVIDERS[i]) {
      console.error("wrong data recieved");
      return;
    }
  }

  const dataMap = {
    firstCellVoltage: ((dataArray[i++] << 8) + dataArray[i++]) / 1000,
    batteryCurrent: ((dataArray[i++] << 8) + dataArray[i++]) / 1000,
    isAvailableRecharging: dataArray[i++] === 1,
    isAvailableDischarging: dataArray[i++] === 1,
    fuelCellVoltage: ((dataArray[i++] << 8) + dataArray[i++]) / 100,
    fuelCellCurrent: ((dataArray[i++] << 8) + dataArray[i++]) / 1000,
    fuellCellTemp: ((dataArray[i++] << 8) + dataArray[i++]) / 10,
    fuellCellFan: dataArray[i++],
    fuelCellOn: dataArray[i++],
    hydrogenConsumption: ((dataArray[i++] << 8) + dataArray[i++]) / 100,
    hydrogenPressure: (dataArray[i++] << 8) + dataArray[i++],
    currentDirection: dataArray[i++]
  };

  for (const id in dataMap) {
    const td = document.getElementById(id);
    if (td) {
      td.innerHTML = dataMap[id] + " " + CAR_PARAMS_ENTRIES[id].units;
    }
  }
}
